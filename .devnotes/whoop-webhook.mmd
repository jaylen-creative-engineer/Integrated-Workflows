sequenceDiagram
    autonumber

    participant WHOOP as WHOOP Webhook Service
    participant NextAPI as Next.js API Route\n(/api/daily-brief-from-whoop)
    participant WhoopAPI as WHOOP REST API
    participant Energy as Energy Model Module
    participant Notion as Notion API

    %% 1. WHOOP sends webhook on sleep/recovery update
    WHOOP->>NextAPI: POST /api/daily-brief-from-whoop\nbody: { user_id, id (UUID), type, trace_id }

    Note over WHOOP,NextAPI: Webhook model version = v2\nTypes: sleep.updated, recovery.updated, etc.[^https://developer.whoop.com/docs/developing/webhooks/]

    Note over NextAPI: Validate X-WHOOP-Signature / Timestamp\nParse payload\nIf type === sleep.updated → proceed

    %% 2. Next.js fetches detailed sleep & recovery via WHOOP API
    NextAPI->>WhoopAPI: GET /v2/activity/sleep/{sleepId}\nAuth: OAuth (read:sleep)[^https://developer.whoop.com/api/#tag/Sleep/operation/getSleepCollection]
    WhoopAPI-->>NextAPI: 200 OK\nsleep: { start, end, timezone_offset, score... }

    NextAPI->>WhoopAPI: GET /v2/recovery?start=...&end=...\nAuth: OAuth (read:recovery)[^https://developer.whoop.com/api/#tag/Sleep/operation/getSleepCollection]
    WhoopAPI-->>NextAPI: 200 OK\nrecords: [ recovery objects ]

    Note over NextAPI: Derive wakeTime = sleep.end\nCompute sleepDebt, sleepPerformance, recoveryScore

    %% 3. Compute energy schedule from WHOOP context
    NextAPI->>Energy: buildEnergyScheduleFromWhoop(sleep, recovery, config)
    Energy-->>NextAPI: energyModelOutput\n(segments: groggy/peaks/dips/wind-down/melatonin,\n dayMode: push/balanced/conserve)

    %% 4. Build Daily Brief content
    Note over NextAPI: Pull sprint/week/tasks/meetings/reading context\nMap items into energy windows\nRender markdown body + properties

    %% 5. Create Daily Brief page in Notion database
    NextAPI->>Notion: POST /v1/pages\nparent: Daily Briefs DB\nproperties + markdown content
    Notion-->>NextAPI: 200 OK\n{ pageId, url }

    Note over Notion: Workspace notifications configured so\n“new page in Daily Briefs DB” → push to your devices

    %% 6. Respond quickly to WHOOP
    NextAPI-->>WHOOP: 200 OK\n{"status": "processed", "briefPageId": "..."}

    Note over WHOOP,NextAPI: WHOOP retries up to 5 times over ~1h\nif non-2XX or timeout.[^https://developer.whoop.com/docs/developing/webhooks/]